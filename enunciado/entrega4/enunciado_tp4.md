# TP 4 - NoSQL - Neo4J
Un maremoto de terror primigenio nos devor√≥ tras la apertura del ata√∫d en las entra√±as h√∫medas del cementerio. En ese breve instante, asfixiados por el temor hacia lo inefable, sentimos como algo dentro nuestro se hab√≠a desaparecido y transferido a otro lugar. Algo tan sutil como un aliento, tan definitivo la extinci√≥n de una estrella. 

Cuando la sensaci√≥n finalmente cedi√≥, s√≥lo qued√≥ la certeza inquietante de que algo muy peligroso hab√≠a sucedido, aunque no sab√≠amos que. En la tumba no encontramos nada.

Al salir de la catacumba, el cementerio parec√≠a normal. Aunque nos sintieramos bien, terminamos ese d√≠a con la certeza de que algo que guardabamos con recelo sin saberlo hab√≠a sido arrebatado de nosotros. 

Las semanas subsiguientes transcurrieron en una espiral descendente hacia la comprensi√≥n de lo incomprensible. La sensacion de p√©rdida de algo esencial en nosotros no desapareci√≥, pero nos acostumbramos lo suficiente para continuar con nuestra misi√≥n. Los informes de desapariciones nocturnas aumentaban exponencialmente d√≠a tras d√≠a, y lo m√°s inquietante: Una parodia grotesca del milagro de L√°zaro; las personas aparec√≠an al d√≠a siguiente, pero diferentes. 

Los bautizamos como "los pose√≠dos". Cuando previas desapariciones solo resultaban en fenomenos extra√±os desarollandose alrededor de los desaparecidos, estos pose√≠dos ya eran hombres directamente dominados por demonios y despojados de su humanidad, sembrando el caos por la ciudad, destruyendo todo a su paso, creando m√°s pose√≠dos de manera forzosa, corrompiendo almas inocentes y asesinando o torturando a quienes se resist√≠eran. Sea lo que sea que robaron de nosotros, los demonios lo estaban utilizando para forzar su conexi√≥n sobre almas inocentes. 

A espaldas del caos, refugiado en mi lecho, una pregunta me atormentaba noche tras noche como una espada de damocles suspendida sobre mi cordura: ¬øPor qu√© osamos introducirnos en aquellos dominios ocultos? ¬°Todo esto era nuestra culpa! ¬øPor qu√© volamos hacia el sol del conocimiento prohibido cuando sab√≠amos que nuestras alas eran de cera y plumas?

Oh sabidur√≠a profana, oh llama del saber, volamos hacia tu abrazo incandescente y no solo nuestras fr√°giles alas se consumieron en tu resplandor, sino que la negra cera que las un√≠a ahora ca√≠a como lluvia de brea ardiente sobre las cabezas de corderos, ajenos a nuestras transgresiones, transformando su carne, deformando sus huesos, pervirtiendo sus almas inocentes. Y sin embargo he aqu√≠ mi m√°s horrible confesi√≥n ¬øPor qu√© persist√≠a a√∫n en m√≠ este anhelo febril por saber m√°s? ¬øPor qu√© no pod√≠a parar de sentir el sabor met√°lico y tibio de mi propia sangre al morder fuertemente mis dedos, incapaz de sostener la ansiedad provocada por el √©xtasis liberador de encajar una pieza m√°s en este terrible rompecabezas infernal?

Pod√≠a ver en los rostros fantasmales de mis compa√±eros que no era el √∫nico cuyos p√°rpados se negaban a cerrarse ante el terror de los sue√±os que aguardaban. Ten√≠amos que terminar con esta pesadilla. 
Ya habiamos probado buscando respuestas en cementerios, y los resultados habian sido funestos. ¬øPor que no probar ahora en los santuarios? 
Abrimos google maps y encontramos un viejo santuario franc√©s aislado en las afueras de la ciudad. Seg√∫n investigaciones posteriores, all√≠ resid√≠an varios √°ngeles que podr√≠an protegernos del continuo deterioro mental del cual ya no pod√≠amos escapar. Ese seria nuestro proximo destino.

Fuimos alli y nos refugiamos en el santuario. La noche profundizaba su cernir sobre nosotros y el viento arremet√≠a con tal intensidad que tem√≠amos que el santuario pudiera derrumbarse. El tiempo era nuestro enemigo; los pose√≠dos se multiplicaban sin cesar, y cada segundo perdido nos acercaba m√°s a nuestra perdici√≥n y a la de todos.

Ya entrada la media noche, tras testear una simulaci√≥n finalmente fallida en la que hab√≠amos estado trabajando durante horas, las puertas del santuario se abrieron de golpe, dejando entrar de manera violenta el viento de la tormenta, volcando todo y apagando las luces. La oscuridad nos envolvi√≥, rota √∫nicamente por el p√°lido brillo de la luna que se filtraba a trav√©s de las puertas abiertas.

En esa tenue iluminaci√≥n, distinguimos una silueta humanoide avanzando por el pasillo de entrada. Pero no caminaba; flotaba en el aire. Jam√°s hab√≠amos visto algo as√≠, y apenas tuvimos tiempo de asimilarlo antes de que todo a nuestro alrededor comenzara a levitar y a arder en llamas. Este pose√≠do mostraba poderes que superaban cualquier cosa que hubi√©ramos visto antes.

El terror por nuestras vidas y la posibilidad de que todo hubiera sido en vano nos paraliz√≥. Pero entonces, de repente, todo... se detuvo. Las llamas se extinguieron como si nunca hubieran existido, los objetos flotantes cayeron estrepitosamente al suelo, y el pose√≠do se desplom√≥ de rodillas frente a nosotros.

Una figura extra√±a emergi√≥ detr√°s de √©l, empapada como si hubiera surgido de las entra√±as de la tormenta. Se acerc√≥ al pose√≠do con una calma inquietante, pos√≥ sus dedos sobre su frente, y en un instante, el pose√≠do cay√≥ al suelo, inm√≥vil, incapacitado, exorcizado.

La figura nos mir√≥ entonces, sus ojos profundos y antiguos como abismos, y comenz√≥ a caminar hacia nosotros. 

Un solo paso. 

Nuestros corazones se estremecieron. ¬øEra salvaci√≥n o condena lo que tra√≠a consigo? No lo sab√≠amos, pero de su ser emanaba una dualidad imposible: Una pureza angelical y una corrupci√≥n demon√≠aca que se entrelazaban en un torbellino de energ√≠as opuestas.

Dio un paso m√°s.

Detr√°s de √©l, una sombra danzaba, girando como un remolino de humo oscuro, adquiriendo formas grotescas y retorcidas, una silueta que mutaba con cada latido, volvi√©ndose cada vez m√°s monstruosa, m√°s tangible.

Otro paso.

El aire se volvi√≥ espeso, pesado, y un sudor fr√≠o comenz√≥ a formarse detr√°s de nuestras nucas. 

Otro paso.

Una sensaci√≥n de opresi√≥n y temor forz√≥ a m√°s de uno a caer de rodillas al suelo, incapaces de soportar el peso de lo que se acercaba. La sombra que lo segu√≠a ahora se contorsionaba en una forma demon√≠aca, afilada, retorcida, hambrienta.

Finalmente, la figura lleg√≥ lo suficientemente cerca como para que podamos distinguir sus rasgos. Era un muchacho. Estaba agotado, con los ojos cargados de una preocupaci√≥n insondable, como si su misma existencia fuera una carga demasiado pesada. 

Mantuvo una distancia cautelosa, pero su presencia lo llenaba todo.

‚ÄúVeran, yo soy RDJ.‚Äù

<p align="center">
  <img src="poseido.png" width="50%" />
</p>

‚ÄúAunque no me comporte como tal, yo tambi√©n soy un pose√≠do.‚Äù

RDJ se ve√≠a como un muchacho joven, no muy distinto que cualquiera si se ignoraba su antebrazo, o mejor dicho, la ausencia de √©l. Su extremidad hab√≠a sido brutalmente arrancada, dejando un mu√±√≥n grotesco que a√∫n chorreaba sangre oscura. Cada paso que RDJ daba parec√≠a dejar una huella de sangre detr√°s, como si la propia tierra estuviera marcada por su dolor y su lucha.

‚ÄúEstuve alli, cuando llegaron a la catacumba. Intente detenerlos, golpie en las piertas de la catacumba gritando sus nombres, pero fue demasiado tarde. Algo sucedio alli que me expulso del cementerio, pero ahora estoy aqu√≠ para ayudarlos a arreglar este apocalipsis.‚Äù - les dice, forzando una sutil sonrisa - ‚ÄúTodo esto tiene soluci√≥n. Necesito que me acompa√±en a donde comenz√≥ todo.‚Äù

Detr√°s de RDJ, el demonio observaba. El tambien habia estado alli, el fue quien robo algo de nosotros. No lo habiamos visto, pero lo sabiamos. Su figura oscura se contorsionaba en el aire como una sombra viva, imposible de definir con claridad, pero su √∫nico ojo, brillante y maligno lo ve√≠a todo. Una sonrisa torcida se dibuj√≥ en su rostro, sus colmillos reluciendo con una malevolencia palpable. Por m√°s que RDJ les prometiera salvaci√≥n, el demonio, en su risa cruel, nos recordaba que estabamos jugando un juego cuyo desenlace ya hab√≠a sido escrito, y no a favor de nosotros.

Mis dedos aun lacerados se movian inquietos en mis bolsillos, al final, no pude evitar sonreir.

## Cambios en nuestra aplicaci√≥n

Las ubicaciones resultaron ser aun mas importantes de lo que consideramos inicialmente, y una simple representacion relacional ya no basta para ser fieles a nuestro negocio. Su poder y notoriedad parece ir mas alla de las tablas y las columnas.

Como primer requerimiento de este TP, deber√°n de persistir las ubicaciones en Neo4J para poder modelar las conexiones entre ellas.

## Servicios

Deberan extender el `UbicacionService`, modificandolo de la siguiente manera:

- Los metodos `CRUD` deberan impactar tanto en Neo4J como en Posgress

- `void conectar(Long idOrigen, Long idDestino)` - Conecta dos ubicaciones existentes, siendo el resultado del metodo una conexi√≥n desde origen hacia destino.
  - Las conexiones no son bidireccionales por defecto, pero es valido que surja una conexi√≥n bidireccional si se conectan `(origen, destino)` y luego `(destino, origen)`

- `Boolean estanConectadas(Long idOrigen, Long idDestino)` - Denota si la ubicaci√≥n origen esta conectada la ubicaci√≥n destino por, unicamente, un salto de distancia.

- `List<Ubicacion> ubicacionesSobrecargadas(Int umbralDeEnergia)` - Retorna todas las ubicaciones del grafo que posean una cantidad de energ√≠a superior al umbral dado

- `List<Ubicacion> caminoMasCorto(Long idOrigen, Long idDestino)` - Dada una ubicaci√≥n de la cual partir, y una a la que se quiere llegar, devuelve el camino de ubicaciones que menos saltos debe dar para alcanzar el destino. Si las dos ubicaciones no est√°n conectadas por ning√∫n camino, se levanta la excepci√≥n `UbicacionesNoConectadasException`.

- `List<ClosenessResult> closenessOf(List<Long> ids)` - Dada una lista de ids de ubicaciones, devuelve una lista de records ClosenessResults tras aplicar el algoritmo de Closeness Centrality a los nodos recibidos.

El record `ClosenessResult` es un record tal que:
```java
public record ClosenessResult(Ubicacion ubicacion, Double closeness) { }
```

Adem√°s, el metodo `mover` de `MediumService` ahora debera validar que la ubicaci√≥n a la que se quiere mover este conectada directamente con la ubicaci√≥n actual del medium. En caso de no estarlo, deber√° arrojar la excepci√≥n `Ubicaci√≥nLejanaException`

## Centralidad y Closeness Centrality

### Centralidad
Dentro de la teoria de grafos y redes, se suelen asignar a los nodos un ranking y/o indice para definir que tan importantes son dentro de la red. Por poner ejemplos:

- En redes sociales, para medir la influencia o popularidad de un usuario
- En redes de internet o urbanas, para identificar a nodos clave dentro de la infraestructura
- En nodos de gente con mutaciones roboticas, para ubicar al infectado m√°s contagioso

Como vemos, lo relevante cuando se habla de centralidad es definir **que tan importantes** son los nodos mediante un **criterio definido**

### Closeness Centrality
**Closeness Centrality** es un criterio que define la importancia de los nodos mediante el inverso de la suma de su distancia al resto de nodos en la red seg√∫n su **camino m√°s corto**.

Pongamos un ejemplo.

<p align="center">
  <img src="graph.png" width="50%" />
</p>

En este grafo, si quisieramos calcular la centralidad del nodo B, deberiamos calcular su distancia con los nodos A, C, D y E, viendo que:

| nodo destino | distancia |
|--------------|-----------|
| A            | 1         |
| C            | 1         |
| D            | 1         |
| E            | 1         |

Sumando las distancias, obtenemos 4, por lo que la centralidad del nodo B seg√∫n el criterio de Closeness Centrality 0.25. Justificaci√≥n:
```
  sumatoria de distancias = 4
  inverso de la sumatoria = 1 / 4

  indice = 0.25 (resultado de 1 / 4)
```

Calculemos ahora la distancia de E para ver como muta el indice de centralidad.

| nodo destino | distancia |
|--------------|-----------|
| A            | 2         |
| B            | 1         |
| C            | 2         |
| D            | 1         |

En este caso, la sumatoria de la distancia nos da 6, por lo que el indice es 0.1666...

```
  sumatoria de distancias = 6
  inverso de la sumatoria = 1 / 6

  indice = 0.1666.. (resultado de 1 / 6)
```

Para calcular este algoritmo deberiamos, entonces:
```
- conseguir el nodo del que queremos conocer su centralidad
- calcular sus caminos m√°s cortos hasta el resto de nodos de la red
- sumar la longitud de esos caminos
- dividir 1 entre la sumatoria
```

### Se pide:
- Implementar los requerimientos utilizando una base de datos orientada a grafos a su criterio.
- Extiendan el `UbicacionController` incluyendo los nuevos metodos implementados.
- Creen test unitarios para cada unidad de c√≥digo entregada que prueben todas las funcionalidades pedidas, con casos favorables y desfavorables.

## Consideraciones
- Discutan en el equipo que entidades deben persistir en Neo4J, adem√°s de:
  - ¬øComo persistirlo?
  - Si debe tener referencia a la *'fuente de verdad'* de la aplicaci√≥n
- Los metodos estan planteados de manera tal que su dificultad sea incremental y, adem√°s, les sirva para encontrar las herramientas necesarias para los requerimientos posteriores.
- Se respalden en la documentaci√≥n oficial de Neo4J para investigar como resolver algunos de los metodos.
- Recuerden que, al momento de crear la instancia de la base en Neo4J Desktop:
  - La contrase√±a debe ser `rootroot` (Neo pide 8 caracteres)
  - La versi√≥n de Neo4J que deben usar para la base es la `5.23.0`

## *~~Bonus~~* Investigaci√≥n e Implementaciones extras

Luego de implementar el calculo de centralidad de los nodos viendo el *"que tan cerca"* estaban con **Closeness Centrality**, el equipo de desarrolladores, sentados a altas horas de la noche mientras admiraban las estrellas, charlaban tranquilamente, observando las constelaciones y definiendo formas para decidir que cuerpos celestes era el m√°s importante: ¬øSeg√∫n su brillo? ¬øSeg√∫n si estaba en una constelaci√≥n? ¬øIncluso por su relaci√≥n con alg√∫n signo zodiacal o similares?.

La charla siguio por horas hasta que algunos, embalados por sus ideas, decidieron implementar sus criterios en el sistema de las ubicaciones y decir cual era la mejor opci√≥n.

### üîç Investigaci√≥n

Deberan investigar otros algoritmos de centralidad. Para ello, les dejamos un [enlace a Wikipedia](https://en.wikipedia.org/wiki/Centrality) donde veran listados algunos de los criterios y algoritmos (incluidas variables de algunos) usados para calcular la centralidad de los nodos en una red. Luego de leerlos, deberan de elegir uno (distinto a Closeness Centrality, obviamente) para implementarlo y comparar su performance contra el algoritmo de Closeness Centrality.

### üíª Implementaci√≥n

Tras elegir uno de los algoritmos, deber√°n implementarlo mediante una query de Cypher que lo ejecute sobre una lista de nodos que se reciban por parametro. Luego de implementarlo, deber√°n probarlo mediante Postman y mandar una captura de los tiempos que tarda en correr el algoritmo y retornar la respuesta. 

Para esto, tengan en consideraci√≥n el crear un test que les genere una cantidad relevante de datos como por ejemplo: 100 nodos creados, conectados aleatoriamente con otros 10 nodos cada uno.

### üí° Consejos
- Antes de implementar el algoritmo que eligieron, armen la logica en pseudocodigo (Para ejemplo, ver el pseudocodigo de Closeness Centrality). Una vez hecho eso, piensen como llevar dicha logica a Cypher.
- Utilicen el nombre del algoritmo elegido a la hora de nombrar el metodo de manera similar a como definimos el `closenessOf(ids)`
- Para la instanciaci√≥n de los datos, considerar investigar por herramientas equivalentes al `JDBC Template` para Neo4J que nos permitan insertar nodos en la DB sin generar las instancias
